name: CI - macOS

on:
  push:
    branches: [main]
  pull_request:
    branches:
      [
        main,
        feat/*,
        fix/*,
        docs/*,
        style/*,
        refactor/*,
        perf/*,
        test/*,
        chore/*,
        copilot/*,
        claude/*,
      ]

jobs:
  test-and-coverage:
    name: macOS Tests with Coverage
    runs-on: macos-latest
    permissions:
      contents: read
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install kcov
        run: brew install kcov

      - name: Install Bats and Bash
        run: brew install bats-core bash

      - name: Run tests with coverage
        run: |
          export DRY_RUN=true

          # Run tests first
          bats install/macos/ install/common/ tests/files/

          # kcov + bats can fail on macOS runners, so measure shell scripts directly.
          brew_prefix="$(brew --prefix)"
          BASH_BIN="${brew_prefix}/bin/bash"
          test -x "${BASH_BIN}"

          mkdir -p coverage/raw
          kcov_target_scripts=(
            install/macos/01-brew.sh
            install/macos/02-brew-packages.sh
            install/macos/03-profile.sh
            install/macos/setup.sh
            install/macos/brew-dump-explicit.sh
          )

          raw_dirs=()
          for script in "${kcov_target_scripts[@]}"; do
            name="$(basename "${script}" .sh)"
            out_dir="coverage/raw/${name}"
            raw_dirs+=("${out_dir}")
            kcov --exclude-pattern=/usr,/opt/homebrew,/System "${out_dir}" "${BASH_BIN}" "${script}" || true
          done

          # Merge coverage reports and keep this step non-fatal when no report is generated.
          if [ "${#raw_dirs[@]}" -gt 0 ]; then
            kcov --merge coverage "${raw_dirs[@]}" || true
          fi

          if [ -f coverage/cobertura.xml ]; then
            echo "coverage/cobertura.xml generated"
          else
            echo "coverage/cobertura.xml not generated; skipping strict validation"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/cobertura.xml
          flags: macos
          name: coverage-macos
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  shellcheck:
    name: ShellCheck and shfmt
    runs-on: macos-latest
    permissions:
      contents: read
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run ShellCheck and shfmt
        uses: ./.github/actions/shellcheck-shfmt
        with:
          os: macos
