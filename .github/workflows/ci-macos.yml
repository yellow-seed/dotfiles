name: CI - macOS

on:
  push:
    branches: [main]
  pull_request:
    branches:
      [
        main,
        feat/*,
        fix/*,
        docs/*,
        style/*,
        refactor/*,
        perf/*,
        test/*,
        chore/*,
        copilot/*,
        claude/*,
      ]

jobs:
  test-and-coverage:
    name: macOS Tests with Coverage
    runs-on: macos-latest
    permissions:
      contents: read
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install kcov
        run: brew install kcov

      - name: Install Bats and Bash
        run: brew install bats-core bash

      - name: Run tests with coverage
        run: |
          export DRY_RUN=true

          # Run tests (BATS) separately
          bats install/macos/ install/common/ tests/files/

          # kcov + bats can fail on some bats-core internals, so measure script coverage directly
          # Use Homebrew bash (instead of /bin/bash) to avoid kcov open errors on macOS runner
          brew_prefix="$(brew --prefix)"
          BASH_BIN="${brew_prefix}/bin/bash"
          test -x "${BASH_BIN}"
          bash_dir="$(dirname "${BASH_BIN}")"
          export PATH="${bash_dir}:${PATH}"

          mkdir -p coverage/raw
          kcov --exclude-pattern=/usr,/opt/homebrew,/System coverage/raw/01-brew "${BASH_BIN}" install/macos/01-brew.sh
          kcov --exclude-pattern=/usr,/opt/homebrew,/System coverage/raw/02-brew-packages "${BASH_BIN}" install/macos/02-brew-packages.sh
          kcov --exclude-pattern=/usr,/opt/homebrew,/System coverage/raw/03-profile "${BASH_BIN}" install/macos/03-profile.sh
          kcov --exclude-pattern=/usr,/opt/homebrew,/System coverage/raw/setup "${BASH_BIN}" install/macos/setup.sh

          # Merge coverage reports and ensure Codecov input exists
          kcov --merge coverage coverage/raw/01-brew coverage/raw/02-brew-packages coverage/raw/03-profile coverage/raw/setup
          test -f coverage/cobertura.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/cobertura.xml
          flags: macos
          name: coverage-macos
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  shellcheck:
    name: ShellCheck and shfmt
    runs-on: macos-latest
    permissions:
      contents: read
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run ShellCheck and shfmt
        uses: ./.github/actions/shellcheck-shfmt
        with:
          os: macos
