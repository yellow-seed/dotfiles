name: Chezmoi Dry-Run Comment

on:
  pull_request:
    paths:
      - 'home/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  chezmoi-dryrun:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)"
          sudo mv ./bin/chezmoi /usr/local/bin/

      - name: Run chezmoi dry-run and capture output
        id: dryrun
        run: |
          echo "## Chezmoi Dry-Run Output (Ubuntu/Linux)" > dryrun_output.txt
          echo "" >> dryrun_output.txt
          echo '```' >> dryrun_output.txt
          chezmoi apply --dry-run --verbose --source="${GITHUB_WORKSPACE}/home" 2>&1 | tee -a dryrun_output.txt || true
          echo '```' >> dryrun_output.txt
          echo "" >> dryrun_output.txt
          
          echo "### Template Expansions" >> dryrun_output.txt
          echo "" >> dryrun_output.txt
          
          # Check if .chezmoi.toml.tmpl exists and expand it
          if [ -f "home/.chezmoi.toml.tmpl" ]; then
            echo "#### .chezmoi.toml.tmpl" >> dryrun_output.txt
            echo '```toml' >> dryrun_output.txt
            chezmoi execute-template < home/.chezmoi.toml.tmpl 2>&1 >> dryrun_output.txt || echo "Error expanding template" >> dryrun_output.txt
            echo '```' >> dryrun_output.txt
            echo "" >> dryrun_output.txt
          fi
          
          # Check if dot_gitconfig.tmpl exists and expand it (just credential section)
          if [ -f "home/dot_gitconfig.tmpl" ]; then
            echo "#### dot_gitconfig.tmpl (credential section)" >> dryrun_output.txt
            echo '```gitconfig' >> dryrun_output.txt
            cat > /tmp/test_data.yaml << 'EOF'
          data:
            name: "user"
            email: "user@example.com"
          EOF
            chezmoi execute-template --config /tmp/test_data.yaml < home/dot_gitconfig.tmpl 2>&1 | grep -A 2 "\[credential\]" >> dryrun_output.txt || echo "No credential section" >> dryrun_output.txt
            echo '```' >> dryrun_output.txt
            echo "" >> dryrun_output.txt
          fi
          
          # Check if dot_zshrc.tmpl exists and expand it (just PNPM section)
          if [ -f "home/dot_zshrc.tmpl" ]; then
            echo "#### dot_zshrc.tmpl (PNPM_HOME)" >> dryrun_output.txt
            echo '```bash' >> dryrun_output.txt
            chezmoi execute-template --config /tmp/test_data.yaml < home/dot_zshrc.tmpl 2>&1 | grep "PNPM_HOME" | head -1 >> dryrun_output.txt || echo "No PNPM_HOME" >> dryrun_output.txt
            echo '```' >> dryrun_output.txt
            echo "" >> dryrun_output.txt
          fi
          
          echo "---" >> dryrun_output.txt
          echo "*This comment is automatically generated by the Chezmoi Dry-Run workflow.*" >> dryrun_output.txt

      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('dryrun_output.txt', 'utf8');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Chezmoi Dry-Run Output')
            );
            
            const commentBody = output;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
